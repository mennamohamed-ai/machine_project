import sys
import joblib
import numpy as np
from PIL import Image
from pathlib import Path

# HOG implementation (same as training script)
def _conv2d(img, kernel):
    kh, kw = kernel.shape
    pad_h, pad_w = kh//2, kw//2
    padded = np.pad(img, ((pad_h, pad_h), (pad_w, pad_w)), mode="edge")
    out = np.zeros_like(img)
    for i in range(img.shape[0]):
        for j in range(img.shape[1]):
            out[i, j] = np.sum(padded[i:i+kh, j:j+kw] * kernel)
    return out

def compute_hog(img, ppc=(8,8), cpb=(2,2), orientations=9):
    kx = np.array([[-1,0,1],[-2,0,2],[-1,0,1]])
    ky = np.array([[-1,-2,-1],[0,0,0],[1,2,1]])

    gx = _conv2d(img, kx)
    gy = _conv2d(img, ky)
    mag = np.hypot(gx, gy)
    ang = np.rad2deg(np.arctan2(gy, gx)) % 180

    ch, cw = ppc
    ncy, ncx = img.shape[0]//ch, img.shape[1]//cw
    bins = orientations
    bin_w = 180/bins

    cell_hist = np.zeros((ncy, ncx, bins))
    for cy in range(ncy):
        for cx in range(ncx):
            m = mag[cy*ch:(cy+1)*ch, cx*cw:(cx+1)*cw].ravel()
            a = ang[cy*ch:(cy+1)*ch, cx*cw:(cx+1)*cw].ravel()
            inds = np.floor(a/bin_w).astype(int)
            inds[inds==bins] = bins-1
            for b, val in zip(inds, m):
                cell_hist[cy, cx, b] += val

    by, bx = cpb
    blocks = []
    eps = 1e-6

    for cy in range(ncy-by+1):
        for cx in range(ncx-bx+1):
            block = cell_hist[cy:cy+by, cx:cx+bx].ravel()
            block = block / (np.linalg.norm(block) + eps)
            block = np.minimum(block, 0.2)
            block = block / (np.linalg.norm(block) + eps)
            blocks.append(block)

    return np.hstack(blocks)

# Load models
scaler = joblib.load("./tometo/tometo_outputs/scaler.joblib")
model = joblib.load("./tometo/tometo_outputs/logistic.joblib")

IMAGE_SIZE = (64, 64)

# Ask user for image path as input
img_path = input("Enter image path: ")

if not Path(img_path).exists():
    print("Error: Image not found.")
    sys.exit(1)



if not Path(img_path).exists():
    print("Error: Image not found.")
    sys.exit(1)

# Process image
img = Image.open(img_path).convert("L").resize(IMAGE_SIZE)
arr = np.array(img) / 255.0
hog = compute_hog(arr)
hog = hog.reshape(1, -1)

# Scale features
hog_s = scaler.transform(hog)

# Predict
proba = model.predict_proba(hog_s)[0,1]
cls = 1 if proba >= 0.5 else 0
label = "Rotten" if cls == 1 else "Fresh"

print(f"Prediction: {label}")
print(f"Fresh probability: {1-proba:.4f}")
print(f"Rotten probability: {proba:.4f}")
